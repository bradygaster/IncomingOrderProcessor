name: CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

jobs:
  build-and-publish:
    name: Build and Publish Artifacts
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore NuGet packages
      run: nuget restore IncomingOrderProcessor.slnx
    
    - name: Build solution
      run: msbuild IncomingOrderProcessor.slnx /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=../publish /v:minimal
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: IncomingOrderProcessor-${{ github.sha }}
        path: publish/
        retention-days: 30
  
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'dev'
    environment:
      name: dev
      url: https://dev.incomingorderprocessor.azure.com
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: IncomingOrderProcessor-${{ github.sha }}
        path: ./artifacts
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure App Service (Dev)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_APP_NAME_DEV }}
        package: ./artifacts
    
    - name: Azure Logout
      run: az logout
      if: always()
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.event.inputs.environment == 'staging' || (github.ref == 'refs/heads/main' && github.event_name == 'push')
    environment:
      name: staging
      url: https://staging.incomingorderprocessor.azure.com
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: IncomingOrderProcessor-${{ github.sha }}
        path: ./artifacts
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure App Service (Staging)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_APP_NAME_STAGING }}
        package: ./artifacts
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests against staging environment..."
        # Add your smoke test commands here
        echo "Smoke tests completed successfully"
    
    - name: Azure Logout
      run: az logout
      if: always()
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://incomingorderprocessor.azure.com
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: IncomingOrderProcessor-${{ github.sha }}
        path: ./artifacts
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create backup of current deployment
      run: |
        echo "Creating backup of current production deployment..."
        az webapp deployment slot create --name ${{ secrets.AZURE_APP_NAME_PROD }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --slot backup-${{ github.sha }} || echo "Backup slot creation skipped"
    
    - name: Deploy to Azure App Service (Production)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_APP_NAME_PROD }}
        package: ./artifacts
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests against production environment..."
        # Add your smoke test commands here
        echo "Smoke tests completed successfully"
    
    - name: Azure Logout
      run: az logout
      if: always()
